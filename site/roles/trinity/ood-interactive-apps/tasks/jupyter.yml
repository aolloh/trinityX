---
- name: Install Jupyter Notebook on the controller
  when:
    - on_controller|default(False)
    - ansible_connection not in 'chroot'
  block:
    - name: Create Jupyter Notebook interactive app directory
      ansible.builtin.file:
        path: "{{ ood_interactive_apps_path }}/bc_jupyter"
        state: directory
        owner: root
        group: root
        mode: "0755"
      notify: Run update_ood

    - name: Download Jupyter Notebook interactive app
      ansible.builtin.unarchive:
        src: "{{ ood_interactive_apps_jupyter_url }}"
        dest: "{{ ood_interactive_apps_path }}/bc_jupyter"
        remote_src: true
        extra_opts:
          - --transform
          - s#OOD-bc-jupyter-[a-zA-Z0-9.]*/#/#g
      notify: Run update_ood

    - name: Set permissions for app
      ansible.builtin.file:
        path: "{{ ood_interactive_apps_path }}/bc_jupyter"
        state: directory
        recurse: true
        owner: root
        group: root
        mode: u=rw,g=r,o=r,a-x+X
      notify: Run update_ood

    - name: Set permissions for template files
      ansible.builtin.file:
        path: "{{ ood_interactive_apps_path }}/bc_jupyter/template"
        state: directory
        recurse: true
        mode: +x
      notify: Run update_ood

    - name: Render python environment module for Jupyter Notebook
      ansible.builtin.template:
        src: jupyter/python-module.lua.j2
        dest: "{{ trix_shared }}/modulefiles/ood-jupyter-python.lua"
        mode: "0644"
        owner: root
        group: root
      notify: Run update_ood

    - name: Copy icon.png
      ansible.builtin.copy:
        src: jupyter/icon.png
        dest: "{{ ood_interactive_apps_path }}/bc_jupyter/icon.png"
        mode: "0644"
        owner: root
        group: root
      notify: Run update_ood

    - name: Render form.yml
      ansible.builtin.template:
        src: jupyter/form.yml.j2
        dest: "{{ ood_interactive_apps_path }}/bc_jupyter/form.yml"
        mode: "0644"
        owner: root
        group: root
      notify: Run update_ood

    - name: Render the manifest.yml.j2
      ansible.builtin.template:
        src: jupyter/manifest.yml.j2
        dest: "{{ ood_interactive_apps_path }}/bc_jupyter/manifest.yml"
        owner: root
        group: root
        mode: "0644"
      notify: Run update_ood

- name: Install jupyter notebook on the compute nodes
  block:
    - name: Install python3-pip dependency for Jupyter Notebook
      ansible.builtin.apt:
        name:
          - python3-pip
          - python3-venv
        state: present
        update_cache: true
      when: ansible_facts['os_family'] == 'Debian'

    - name: Install python3-pip dependency for Jupyter Notebook
      ansible.builtin.dnf:
        name: python3-pip
        state: present
        disable_gpg_check: true
      when: ansible_facts['os_family'] == "RedHat"
      retries: "{{ rpm_retries | default(3) }}"
      delay: "{{ rpm_delay | default(15) }}"

    - name: Create Python virtual environment for Jupyter Notebook
      ansible.builtin.command: python3 -m venv /opt/ood-jupyter-python
      register: venv_output
      changed_when: venv_output.rc != 0
      when: ansible_connection in 'chroot'
