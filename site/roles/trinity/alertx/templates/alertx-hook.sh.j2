#!/bin/bash

{% if luna_protocol == "https" -%}
PROTOCOL='https'
{% else %}
PROTOCOL='http'
{% endif %}

{% if luna_verify_certificate | bool %}
INSECURE=''
{% else %}
INSECURE='--insecure'
{% endif %}

LUNA_PORT=7050
LUNA_URL=${PROTOCOL}://{{ trix_ctrl_ip }}:${LUNA_PORT}
INTERFACE=''

HOST=$(hostname|awk -F'.' '{ print $1 }')

function get_credentials {
    LUNA_INI='/trinity/local/luna/node/config/luna.ini'
    if [ -f $LUNA_INI ]; then
        while IFS='=' read -ra line; do
            if [ ! "$(echo $line | grep -E '^(#|;)')" ] && [ "$line" ]; then
                if [ "$(echo $line | grep '^\[')" ]; then
                    section=$(echo $line | grep -oE "[A-Z]+")
                else
                    key=$(echo ${line[0]})
                    value=$(echo ${line[1]})
                    declare -x "${section}_${key}"="$value"
                fi
            fi
        done < "$LUNA_INI"
    else
        >&2 echo "No config file: $LUNA_INI"
        echo ":"
    fi
    echo "${API_USERNAME}:${API_PASSWORD}"
}

function fetch_token {
    CREDENTIALS=$(get_credentials)
    USERNAME=$(echo $CREDENTIALS | awk -F':' '{ print $1 }')
    PASSWORD=$(echo $CREDENTIALS | awk -F':' '{ print $2 }')
    export TPM2TOOLS_TCTI="device:/dev/tpm0"
    ldconfig
    TPM=$(tpm2_pcrread sha256:0 2> /dev/null | grep '0x' | awk -F' : ' '{ print $2 }')
    json='{"tpm_sha256":"'$TPM'","username":"'$USERNAME'","password":"'$PASSWORD'"}'
    touch /tmp/token.json
    chmod og-rwx /tmp/token.json
    curl $INTERFACE $INSECURE -X POST -H "Content-Type: application/json" -d "$json" -s "${LUNA_URL}/tpm/${HOST}" > /tmp/token.json
    valid=$(grep token /tmp/token.json)
    if [ "$valid" ]; then
        token=$(cat /tmp/token.json | awk '{ print $2 }' | grep -oE '"(\S+)"')
        token=$(echo "${token:1:-1}")
        echo $token
    else
        >&2 cat /tmp/token.json
        >&2 echo
        echo "None"
    fi
}

function call_hook {
    LUNA_TOKEN=$(fetch_token)
    json='[{ "hostname": "'$HOST'", "force": false}]'
    curl $INTERFACE $INSECURE -X POST -H "x-access-tokens: $LUNA_TOKEN" -H "Content-Type: application/json" -d "$json" -s "${LUNA_URL}/import/prometheus_nhc_rules"
    return $?
}

call_hook
exit $?

